# GitLab CI/CD Configuration for Neuro-OS
#
# This configuration provides comprehensive CI/CD for GitLab including:
# - Multi-stage pipeline (build, test, deploy)
# - Caching strategy for faster builds
# - Artifact management
# - Performance testing
# - Security scanning
# - Docker image builds
#
# Variables can be configured in GitLab CI/CD settings

# Global configuration
image: ubuntu:22.04

variables:
  # Cargo configuration
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  
  # Cache configuration
  CACHE_COMPRESSION_LEVEL: fastest
  
  # Build configuration
  BUILD_TYPE: release

# Define stages
stages:
  - prepare
  - build
  - test
  - security
  - performance
  - deploy

# ===========================================================================
# TEMPLATES
# ===========================================================================

.rust_base:
  before_script:
    - apt-get update && apt-get install -y curl build-essential
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustc --version
    - cargo --version

.cache_template:
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/
      - target/
      - testing/target/
    policy: pull-push

# ===========================================================================
# PREPARE STAGE
# ===========================================================================

cache-warmup:
  stage: prepare
  extends:
    - .rust_base
    - .cache_template
  script:
    - cargo fetch
  only:
    - main
    - develop
    - merge_requests

# ===========================================================================
# BUILD STAGE
# ===========================================================================

build:x86-64:debug:
  stage: build
  extends:
    - .rust_base
    - .cache_template
  script:
    - cd testing
    - cargo build --target x86_64-unknown-linux-gnu
    - ls -lah target/x86_64-unknown-linux-gnu/debug/
  artifacts:
    name: "build-x86-64-debug-$CI_COMMIT_SHORT_SHA"
    paths:
      - testing/target/x86_64-unknown-linux-gnu/debug/
    expire_in: 1 week
  tags:
    - docker

build:x86-64:release:
  stage: build
  extends:
    - .rust_base
    - .cache_template
  script:
    - cd testing
    - cargo build --release --target x86_64-unknown-linux-gnu
    - ls -lah target/x86_64-unknown-linux-gnu/release/
  artifacts:
    name: "build-x86-64-release-$CI_COMMIT_SHORT_SHA"
    paths:
      - testing/target/x86_64-unknown-linux-gnu/release/
    expire_in: 1 month
  tags:
    - docker
  only:
    - main
    - tags

build:arm64:
  stage: build
  extends:
    - .rust_base
    - .cache_template
  script:
    - rustup target add aarch64-unknown-linux-gnu
    - apt-get install -y gcc-aarch64-linux-gnu
    - cd testing
    - cargo build --release --target aarch64-unknown-linux-gnu
  artifacts:
    name: "build-arm64-$CI_COMMIT_SHORT_SHA"
    paths:
      - testing/target/aarch64-unknown-linux-gnu/release/
    expire_in: 1 week
  tags:
    - docker
  only:
    - main
    - tags

build:riscv64:
  stage: build
  extends:
    - .rust_base
    - .cache_template
  script:
    - rustup target add riscv64gc-unknown-linux-gnu
    - apt-get install -y gcc-riscv64-linux-gnu
    - cd testing
    - cargo build --release --target riscv64gc-unknown-linux-gnu
  artifacts:
    name: "build-riscv64-$CI_COMMIT_SHORT_SHA"
    paths:
      - testing/target/riscv64gc-unknown-linux-gnu/release/
    expire_in: 1 week
  tags:
    - docker
  only:
    - main
    - tags

# ===========================================================================
# TEST STAGE
# ===========================================================================

test:unit:
  stage: test
  extends:
    - .rust_base
    - .cache_template
  dependencies:
    - build:x86-64:debug
  script:
    - cd testing
    - cargo test --lib --verbose
  artifacts:
    when: always
    reports:
      junit: testing/target/test-results/*.xml
  tags:
    - docker

test:integration:
  stage: test
  extends:
    - .rust_base
    - .cache_template
  dependencies:
    - build:x86-64:debug
  script:
    - apt-get install -y qemu-system-x86
    - cd testing
    - cargo test --test '*' --verbose
  artifacts:
    when: always
    reports:
      junit: testing/target/test-results/*.xml
  tags:
    - docker

test:property:
  stage: test
  extends:
    - .rust_base
    - .cache_template
  dependencies:
    - build:x86-64:debug
  script:
    - cd testing
    - cargo test property_tests --verbose
  tags:
    - docker

lint:python:
  stage: test
  image: python:3.11
  script:
    - pip install flake8 black mypy
    - black --check scripts/ debugging/
    - flake8 scripts/ debugging/ --max-line-length=100
  tags:
    - docker

lint:rust:
  stage: test
  extends:
    - .rust_base
  script:
    - rustup component add rustfmt clippy
    - cd testing
    - cargo fmt -- --check
    - cargo clippy --all-targets --all-features -- -D warnings
  tags:
    - docker

# ===========================================================================
# SECURITY STAGE
# ===========================================================================

security:audit:
  stage: security
  extends:
    - .rust_base
  script:
    - cargo install cargo-audit
    - cd testing
    - cargo audit
  allow_failure: true
  tags:
    - docker

security:dependencies:
  stage: security
  extends:
    - .rust_base
  script:
    - cargo install cargo-deny
    - cd testing
    - cargo deny check
  allow_failure: true
  tags:
    - docker

security:sast:
  stage: security
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto --json --output=semgrep-report.json .
  artifacts:
    reports:
      sast: semgrep-report.json
  allow_failure: true
  tags:
    - docker

# ===========================================================================
# PERFORMANCE STAGE
# ===========================================================================

performance:benchmark:
  stage: performance
  extends:
    - .rust_base
    - .cache_template
  dependencies:
    - build:x86-64:release
  script:
    - cd testing
    - cargo bench --no-fail-fast
  artifacts:
    name: "benchmarks-$CI_COMMIT_SHORT_SHA"
    paths:
      - testing/target/criterion/
    expire_in: 1 month
  tags:
    - docker
  only:
    - main
    - tags

performance:profile:
  stage: performance
  extends:
    - .rust_base
  dependencies:
    - build:x86-64:release
  script:
    - apt-get install -y linux-tools-generic
    - chmod +x debugging/profilers/profile.sh
    - echo "Profiling would run here with actual binaries"
  allow_failure: true
  tags:
    - docker
  only:
    - main

# ===========================================================================
# DEPLOY STAGE
# ===========================================================================

deploy:documentation:
  stage: deploy
  extends:
    - .rust_base
  script:
    - cd testing
    - cargo doc --no-deps --all-features
    - mkdir -p ../public
    - cp -r target/doc/* ../public/
  artifacts:
    paths:
      - public
  tags:
    - docker
  only:
    - main

deploy:docker:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  tags:
    - docker
  only:
    - main
    - tags

deploy:release:
  stage: deploy
  extends:
    - .rust_base
  dependencies:
    - build:x86-64:release
    - build:arm64
    - build:riscv64
  script:
    - echo "Creating release artifacts"
    - mkdir -p release
    - cp -r testing/target/*/release/* release/
    - tar czf neuro-tools-$CI_COMMIT_TAG.tar.gz release/
  artifacts:
    name: "neuro-tools-$CI_COMMIT_TAG"
    paths:
      - neuro-tools-$CI_COMMIT_TAG.tar.gz
  tags:
    - docker
  only:
    - tags

# ===========================================================================
# CLEANUP
# ===========================================================================

cleanup:cache:
  stage: .post
  script:
    - echo "Cleaning old cache entries"
    - find .cargo -type f -atime +30 -delete || true
  when: always
  tags:
    - docker
